{
  "variables": [
    {
      "id": "hubName",
      "value": "{{#parseAzureResourceId inputs.iotHubId 8}}{{/parseAzureResourceId}}"
    },
    {
      "id": "hubResourceGroup",
      "value": "{{#parseAzureResourceId inputs.iotHubId 4}}{{/parseAzureResourceId}}"
    }
  ],
  "assets": [
    {
      "id": "updateTags",
      "type": "UpdateDeploymentTags",
      "stage": "post",
        "inputs": {
            "resourceId": "/subscriptions/{{inputs.subscriptionId}}/resourceGroups/{{variables.hubResourceGroup}}/providers/Microsoft.Devices/IotHubs/{{variables.hubName}}",
            "apiVersion": "2018-04-01",
            "endpoint": "{{assets.ARMEndpoint_object}}"
        }
    }
  ],
  "releaseDefinition": {
    "environments": [
      {
        "name": "dev",
        "deployedResourceIds": [
          "/subscriptions/{{{inputs.subscriptionId}}}/resourceGroups/{{{variables.hubResourceGroup}}}/providers/Microsoft.Devices/IotHubs/{{{variables.hubName}}}"
        ],
        "variables": {
          "DEVOPS_IOTEDGE_REGISTRY_URL": {
            "value": "{{{inputs.containerRegistryName}}}.azurecr.io"
          }
        },
        "templateFile": "Files/ReleaseDefinitionTemplates/deployIoTEdgeWithExistingHub.json",
        "phaseInputs": [
          {
            "queue": "Bishal",
            "taskInputs": [
              {
                "__TaskId__": "46e4be58-730b-4389-8a2f-ea10b3e5e815",
                "connectedServiceNameARM": "{{{assets.ARMEndpoint}}}",
                "inlineScript": "(az extension add --name azure-cli-iot-ext && az iot hub device-identity show --device-id myEdgeDevice --hub-name {{{variables.hubName}}}) || (az iot hub device-identity create --hub-name {{{variables.hubName}}} --device-id myEdgeDevice --edge-enabled && TMP_OUTPUT=\"$(az iot hub device-identity show-connection-string --device-id myEdgeDevice --hub-name {{{variables.hubName}}})\" && RE=\"\\\"cs\\\":\\s?\\\"(.*)\\\"\" && if [[ $TMP_OUTPUT =~ $RE ]]; then CS_OUTPUT=${BASH_REMATCH[1]}; fi && echo \"##vso[task.setvariable variable=CS_OUTPUT]${CS_OUTPUT}\")"
              },
              {
                "__TaskId__": "80f3f6a0-82a6-4a22-ba7a-e5b8c541b9b8",
                "connectedServiceNameARM": "{{{assets.ARMEndpoint}}}",
                "iothubname": "{{variables.hubName}}"
              }
            ]
          }
        ]
      }
    ]
  }
}